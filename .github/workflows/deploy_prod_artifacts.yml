name: Deploy Production (Artifacts)

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deploy'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'
  ARTIFACT_NAME: 'beauty-manager-dist'
  DEPLOY_PATH: '/var/www/beauty-manager'

jobs:
  build:
    name: Build Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Workaround Rollup optional deps (linux)
        run: |
          npm install --no-save --no-package-lock @rollup/rollup-linux-x64-gnu
          node -e "require('@rollup/rollup-linux-x64-gnu'); console.log('rollup native OK')"

      - name: Run tests
        if: ${{ inputs.skip_tests != 'true' }}
        run: npm test --workspace=apps/api --if-present
        env:
          NODE_ENV: test

      - name: Build shared
        run: npm run build --workspace=packages/shared --if-present

      - name: Build API
        run: npm run build:api

      - name: Build Web
        run: npm run build:web

      - name: Create artifact tarball
        run: |
          mkdir -p artifact
          tar -czf artifact/dist-api.tgz -C apps/api dist
          tar -czf artifact/dist-web.tgz -C apps/web dist
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ)" > artifact/BUILD_TIMESTAMP
          echo "${{ github.sha }}" > artifact/BUILD_SHA

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: artifact/
          retention-days: 7

  deploy:
    name: Deploy to VPS
    needs: build
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout (for deploy script)
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: artifact/

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.VPS_PORT || 22 }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Upload artifacts to VPS
        run: |
          scp -P ${{ secrets.VPS_PORT || 22 }} -i ~/.ssh/deploy_key \
            artifact/dist-api.tgz \
            artifact/dist-web.tgz \
            artifact/BUILD_TIMESTAMP \
            artifact/BUILD_SHA \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/

      - name: Upload deploy script to VPS
        run: |
          scp -P ${{ secrets.VPS_PORT || 22 }} -i ~/.ssh/deploy_key \
            scripts/deploy-prod-artifacts.sh \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/

      - name: Execute deploy on VPS
        run: |
          ssh -p ${{ secrets.VPS_PORT || 22 }} -i ~/.ssh/deploy_key \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "chmod +x /tmp/deploy-prod-artifacts.sh && /tmp/deploy-prod-artifacts.sh"

      - name: Smoke tests
        run: |
          echo "Waiting 20s for service to stabilize..."
          sleep 20

          echo "Testing healthz..."
          HEALTHZ=$(curl -s -o /dev/null -w "%{http_code}" https://app.agendasalaopro.com.br/api/healthz)
          echo "healthz=$HEALTHZ"

          echo "Testing auth..."
          AUTH=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            https://app.agendasalaopro.com.br/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{}')
          echo "auth=$AUTH"

          if [ "$HEALTHZ" != "200" ]; then
            echo "FAIL: healthz expected 200, got $HEALTHZ"
            exit 1
          fi

          if [ "$AUTH" != "400" ]; then
            echo "FAIL: auth expected 400, got $AUTH"
            exit 1
          fi

          echo "SUCCESS: All smoke tests passed"

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
