name: Deploy Production (Artifacts)

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deploy'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  ARTIFACT_NAME: 'beauty-manager-dist'
  DEPLOY_PATH: '/var/www/beauty-manager'

jobs:
  build:
    name: Build Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Workaround Rollup optional deps (linux)
        run: |
          npm install --no-save --no-package-lock @rollup/rollup-linux-x64-gnu
          node -e "require('@rollup/rollup-linux-x64-gnu'); console.log('rollup native OK')"

      - name: Run tests
        if: ${{ !inputs.skip_tests }}
        run: npm test --workspace=apps/api --if-present
        env:
          NODE_ENV: test

      - name: Build shared
        run: npm run build --workspace=packages/shared --if-present

      - name: Build API
        run: npm run build:api

      - name: Build Web
        run: npm run build:web

      - name: Create artifact tarball
        run: |
          mkdir -p artifact
          tar -czf artifact/dist-api.tgz -C apps/api dist
          tar -czf artifact/dist-web.tgz -C apps/web dist
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ)" > artifact/BUILD_TIMESTAMP
          echo "${{ github.sha }}" > artifact/BUILD_SHA

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: artifact/
          retention-days: 7

  deploy:
    name: Deploy to VPS
    needs: build
    runs-on: ubuntu-latest
    environment: production

    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_PORT: ${{ secrets.VPS_PORT }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}

    steps:
      - name: Checkout (for deploy script)
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: artifact/

      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail

          # default do port
          VPS_PORT="${VPS_PORT:-22}"

          # garante que ~/.ssh é diretório (se for arquivo, remove)
          if [ -e "$HOME/.ssh" ] && [ ! -d "$HOME/.ssh" ]; then
            rm -f "$HOME/.ssh"
          fi

          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"

          # grava chave privada (multilinha) sem CRLF
          printf '%s' "$VPS_SSH_KEY" | tr -d '\r' > "$HOME/.ssh/deploy_key"
          chmod 600 "$HOME/.ssh/deploy_key"

          # known_hosts
          touch "$HOME/.ssh/known_hosts"
          chmod 644 "$HOME/.ssh/known_hosts"
          ssh-keyscan -p "$VPS_PORT" -H "$VPS_HOST" >> "$HOME/.ssh/known_hosts" 2>/dev/null

          # teste de conexão (falha aqui = para tudo, com erro claro)
          ssh -i "$HOME/.ssh/deploy_key" -p "$VPS_PORT" \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=yes \
            "$VPS_USER@$VPS_HOST" "echo OK_FROM_RUNNER"

      - name: Upload artifacts to VPS
        shell: bash
        run: |
          set -euo pipefail
          VPS_PORT="${VPS_PORT:-22}"

          scp -P "$VPS_PORT" -i "$HOME/.ssh/deploy_key" \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=yes \
            artifact/dist-api.tgz \
            artifact/dist-web.tgz \
            artifact/BUILD_TIMESTAMP \
            artifact/BUILD_SHA \
            "$VPS_USER@$VPS_HOST:/tmp/"

      - name: Upload deploy script to VPS
        shell: bash
        run: |
          set -euo pipefail
          VPS_PORT="${VPS_PORT:-22}"

          scp -P "$VPS_PORT" -i "$HOME/.ssh/deploy_key" \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=yes \
            scripts/deploy-prod-artifacts.sh \
            "$VPS_USER@$VPS_HOST:/tmp/"

      - name: Execute deploy on VPS
        shell: bash
        run: |
          set -euo pipefail
          VPS_PORT="${VPS_PORT:-22}"

          ssh -p "$VPS_PORT" -i "$HOME/.ssh/deploy_key" \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=yes \
            "$VPS_USER@$VPS_HOST" \
            "chmod +x /tmp/deploy-prod-artifacts.sh && DEPLOY_PATH='${{ env.DEPLOY_PATH }}' /tmp/deploy-prod-artifacts.sh"

      - name: Smoke tests
        shell: bash
        run: |
          set -euo pipefail

          echo "Waiting 20s for service to stabilize..."
          sleep 20

          echo "Testing healthz..."
          HEALTHZ=$(curl -s -o /dev/null -w "%{http_code}" https://app.agendasalaopro.com.br/api/healthz)
          echo "healthz=$HEALTHZ"

          echo "Testing auth..."
          AUTH=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            https://app.agendasalaopro.com.br/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{}')
          echo "auth=$AUTH"

          if [ "$HEALTHZ" != "200" ]; then
            echo "FAIL: healthz expected 200, got $HEALTHZ"
            exit 1
          fi

          if [ "$AUTH" != "400" ]; then
            echo "FAIL: auth expected 400, got $AUTH"
            exit 1
          fi

          echo "SUCCESS: All smoke tests passed"

      - name: Cleanup SSH key
        if: always()
        shell: bash
        run: |
          rm -f "$HOME/.ssh/deploy_key"
